<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML Slice</title>
    <link crossorigin="anonymous" media="all" rel="stylesheet" href="assets/SCSS/main.css">
</head>

<body>
    <header class="header --t05">
        <div class="palms  --t05">
        </div>
        <div class="new  --t05">
        </div>
        <div class="phone  --t05">
        </div>
    </header>
    <main class="warper">
        <section class="warper-games">
            <ul id="gameList">
                <li id="myLoader">
                </li>
            </ul>
        </section>
    </main>
    <script>

        let gamesListURL = "https://www.palmsbet.com/static/games_bg.json";
        let gamesListFilter = [];
        let gameList = document.getElementById("gameList");
        let startList = 0;
        let maxPerLoad = 20;
        let endOfTheList = 0;
        let ticking = false;
        let myLoader = document.getElementById("myLoader");
        let allLoaded = false;


        let playTitle = "Играй";
        let demoTitle = "Демо";


        function getOffset(el) {
            var rect = el.getBoundingClientRect();
            return {
                left: rect.left + window.pageXOffset,
                top: rect.top + window.pageYOffset
            };
        }
        function showOtherItems() {
            console.log("try items");
            let visibleDistance = 300;
            myLoader = document.getElementById("myLoader");

            if (myLoader) {
                if ((window.pageYOffset + window.innerHeight + visibleDistance) > getOffset(myLoader).top) {
                    console.log(getOffset(myLoader).top);
                    // loadAnImage(listOfImages[i]);
                    if (!allLoaded) {
                        printHTML();
                    }
                }
            }

        }


        window.addEventListener('scroll', function (e) {
            if (!ticking) {
                window.requestAnimationFrame(function () {
                    showOtherItems();
                    ticking = false;
                });
                ticking = true;
            }
        });


        function printHTML() {
            ticking = true;
            let allItemsCont = Object.keys(gamesListFilter).length;
            console.log(endOfTheList);

            endOfTheList += maxPerLoad;
            if (endOfTheList > allItemsCont) {
                endOfTheList = allItemsCont;
                allLoaded = true;
            }
            myLoader = document.getElementById("myLoader");
            myLoader.remove();

            for (startList; startList < endOfTheList; startList++) {
                console.log("startList");
                console.log(gamesListFilter[startList][1]);
                console.log(startList);

                let item = document.createElement("LI");
                item.innerHTML = '<a href="' + gamesListFilter[startList][1].launch_url + '"><figure style="background-image:url(' + gamesListFilter[startList][1].img_url + ');"></figure></a><div class="gameInfo"><span>' + gamesListFilter[startList][1].name + '</span></div><div class="gamePlay"><a href="' + gamesListFilter[startList][1].demo_launch_url + '">' + demoTitle + '</a><a href="' + gamesListFilter[startList][1].launch_url + '">' + playTitle + '</a></div>';
                let att = document.createAttribute("data-id");
                att.value = gamesListFilter[startList][0];
                item.setAttributeNode(att);
                gameList.appendChild(item);

            }
            if (!allLoaded) {
                let item = document.createElement("LI");
                item.id = "myLoader";
                gameList.appendChild(item);
            }
            ticking = false;
        }


        function sortData(data) {
            let obj = data.game_list;
            Object.keys(obj).forEach(function (key, value) {
                if (key, obj[key].vendor_code === "CTRGSECASINO") {
                    gamesListFilter.push([key, obj[key]]);
                }
            });
            printHTML();
        }

        fetchGamesList((error, data) => {
            if (error)
                console.log(error);
            //show loading
            //retry after 10 s max 3~5 times
            //if still error show OPS something is wrong !
            else
                sortData(data);
        });

        function fetchGamesList(callback) {
            fetch(gamesListURL)
                .then(response => response.json())
                .then(json => callback(null, json))
                .catch(error => callback(error, null))
        }

    </script>

</body>

</html>